---
title: "Training Load"
author: "Dominik Rappaport"
date: "2025-08-03"
output: github_document
---

```{r setup, include=FALSE, echo=FALSE}

# Load libraries ----------------------------------------------------------

library("tidyverse")
library("lubridate")
library("bbplot")
library("scales")
library(knitr)

# Read from files ---------------------------------------------------------

tl <- read_csv("data/processed/trainingload.csv")

# Reformat table ----------------------------------------------------------

tl <- tl %>%
  mutate(
    date = as.Date(date, format = "%d.%m.%y"), 
    year = as.factor(year(date)),
    month = as.factor(month(date)),
    week  = as.factor(isoweek(date)),
    day = as.factor(day(date)),
    duration = as.numeric(hms(duration), units="hours"),
    date2 = as.Date(paste0("2001", "-", month, "-", day)))

```

# Trainingsstatistiken

Übersicht über Trainingsstunden, TSS und CTL für die Jahre 2020 bis 2025. Als Zeitraum zum Berechnen des Durchschnitts wurden alle (bereits verstrichenen) Wochen des jeweiligen Jahres herangezogen und nicht nur jene, an denen ein Training grundsätzlich möglich war. Als Konsequenz drücken zum Beispiel Urlaube, Krankenstände oder Dienstreisen den Schnitt.

```{r, echo=FALSE}
days_in_year_elapsed <- function(y) {
  year = as.numeric(as.character(y))
  today <- today()
  current_year <- year(today)
  
  if (year < current_year) {
    return(if_else(leap_year(year), 366, 365))
  } else if (year == current_year) {
    return(yday(today))  # Number of days since Jan 1 including today
  } else {
    stop("Year is in the future; elapsed days are not defined.")
  }
}

yearly_statistics <- tl %>% 
  group_by(year) %>%
  summarise(
    training_hours_per_year = sum(duration, na.rm = TRUE),
    training_hours_per_week = training_hours_per_year,
    TSS_per_year = sum(TSS, na.rm = TRUE),
    TSS_per_week = TSS_per_year,
    average_CTL = mean(CTL, na.rm = TRUE),
  ) %>%
  rowwise() %>%
  mutate(
    training_hours_per_week = training_hours_per_week / days_in_year_elapsed(year) * 7,
    TSS_per_week = TSS_per_week / days_in_year_elapsed(year) * 7
  )
kable(
  yearly_statistics, 
  caption = "Trainingsstatistik",
  col.names = c("Jahr", "Trainingsstunden", "Trainingsstunden pro Woche (Ø)", "TSS", "TSS pro Woche (Ø)", "CTL (Ø)"),
  digits = c(0, 0, 2, 0, 0, 0),
  format.args = list(big.mark = "&#8239;", decimal.mark = ",", scientific = FALSE)
)
```

```{r, echo=FALSE, fig.height=30, warning=FALSE}
tl %>%
  ggplot(aes(x = date2, y = CTL)) +
  geom_line(colour = "#1380A1", linewidth = 1) +
  geom_hline(yintercept = 0,
             linewidth = 1,
             colour = "#333333") +
  scale_x_date(
    date_labels = "%b"
  ) +
  scale_y_continuous(
    limits = c(0, 80),
    breaks = seq(0, 80, 10),
  ) +
  facet_wrap(~ year, ncol = 1) +
  bbc_style() +
  labs(title = "Chronische Trainingslast (CTL)")
```
