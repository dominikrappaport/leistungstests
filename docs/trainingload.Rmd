---
title: "Trainingsstatisik"
author: "Dominik Rappaport"
output:
  github_document:
    toc: true
    toc_depth: 3
---

```{r setup, include=FALSE, echo=FALSE}

# Load libraries ----------------------------------------------------------

library("tidyverse")
library("lubridate")
library("bbplot")
library("scales")
library(knitr)

# Read from files ---------------------------------------------------------

tl <- read_csv("data/processed/trainingload.csv")

# Reformat table ----------------------------------------------------------

tl <- tl %>%
  mutate(
    date = as.Date(date, format = "%d.%m.%y"), 
    year = as.factor(year(date)),
    month = as.factor(month(date)),
    week  = as.factor(isoweek(date)),
    day = as.factor(day(date)),
    duration = as.numeric(hms(duration), units="hours"),
    date2 = as.Date(paste0("2001", "-", month, "-", day))
  )

```

## Trainingsstatistiken

Übersicht über Trainingsstunden, TSS und CTL für die Jahre 2020 bis 2025. Als Zeitraum zum Berechnen des Durchschnitts wurden alle (bereits verstrichenen) Wochen des jeweiligen Jahres herangezogen und nicht nur jene, an denen ein Training grundsätzlich möglich war. Als Konsequenz drücken zum Beispiel Urlaube, Krankenstände oder Dienstreisen den Schnitt.

```{r, echo=FALSE}
days_in_year_elapsed <- function(y) {
  year = as.numeric(as.character(y))
  today <- today()
  current_year <- year(today)
  
  if (year < current_year) {
    return(if_else(leap_year(year), 366, 365))
  } else if (year == current_year) {
    return(yday(today))  # Number of days since Jan 1 including today
  } else {
    stop("Year is in the future; elapsed days are not defined.")
  }
}

yearly_statistics <- tl %>% 
  group_by(year) %>%
  summarise(
    training_hours_per_year = sum(duration, na.rm = TRUE),
    training_hours_per_week = training_hours_per_year,
    TSS_per_year = sum(TSS, na.rm = TRUE),
    TSS_per_week = TSS_per_year,
    average_CTL = mean(CTL, na.rm = TRUE),
  ) %>%
  rowwise() %>%
  mutate(
    training_hours_per_week = training_hours_per_week / days_in_year_elapsed(year) * 7,
    TSS_per_week = TSS_per_week / days_in_year_elapsed(year) * 7
  )
kable(
  yearly_statistics, 
  col.names = c("Jahr", "Trainingsstunden", "Trainingsstunden pro Woche (Ø)", "TSS", "TSS pro Woche (Ø)", "CTL (Ø)"),
  digits = c(0, 0, 2, 0, 0, 0),
  format.args = list(big.mark = "&#8239;", decimal.mark = ",", scientific = FALSE)
)
```

## Verlauf der chronischen Trainingslast

### Verlauf gesamt

```{r, echo=FALSE, warning=FALSE}
tl %>%
  ggplot(aes(x = date, y = CTL)) +
  geom_line(colour = "#1380A1", linewidth = 1) +
  geom_hline(yintercept = 0,
             linewidth = 1,
             colour = "#333333") +
  scale_x_date() +
  scale_y_continuous(
    limits = c(0, 80),
    breaks = seq(0, 80, 10),
  ) +
  bbc_style()
```

### Verlauf nach Jahren

```{r, echo=FALSE, fig.height=30, warning=FALSE}
tl %>%
  ggplot(aes(x = date2, y = CTL)) +
  geom_line(colour = "#1380A1", linewidth = 1) +
  geom_hline(yintercept = 0,
             linewidth = 1,
             colour = "#333333") +
  scale_x_date(
    date_labels = "%b"
  ) +
  scale_y_continuous(
    limits = c(0, 80),
    breaks = seq(0, 80, 10),
  ) +
  facet_wrap(~ year, ncol = 1) +
  bbc_style()
```

## Krankenstandstage

```{r, echo=FALSE, warning=FALSE}
# Read from files ---------------------------------------------------------

sickness <- read_csv("data/processed/sickness.csv", show_col_types = FALSE)

# Reformat table ----------------------------------------------------------

sickness <- sickness %>%
  mutate(
    date = as.Date(date, format = "%d.%m.%y"),
    year = year(date),
    sickness = as.factor(sickness)
  )

# Evaluate and display table

sickdays <- sickness %>%
  mutate(sickdays = ifelse(sickness == "Healthy", 0, 1)) %>%
  select(year, sickdays) %>%
  group_by(year) %>%
  summarise(
    sickdays = sum(sickdays),
  )

kable(
  sickdays, 
  col.names = c("Jahr", "Anzahl Krankenstandstage")
  )
```

## TSS pro Kalenderwoche

### Verlauf nach Jahren

```{r, echo=FALSE, fig.height = 20, warning=FALSE}

# Read from files ---------------------------------------------------------

tl <- read_csv("data/processed/trainingload.csv", show_col_types = FALSE)

# Reformat table ----------------------------------------------------------

tl <- tl %>%
  mutate(
    date = as.Date(date, format = "%d.%m.%y"), 
    year = as.factor(year(date)),
    week  = isoweek(date)
  ) %>%
  select(year, week, TSS)

# Calculate TSS per week --------------------------------------------------

tl <- tl %>%
  group_by(year, week) %>%
  summarise(
    TSS = sum(TSS, na.rm = TRUE),
    .groups = "drop"
  )

# Plot results ------------------------------------------------------------

tl %>%
  ggplot(aes(x = week, y = TSS)) +
  geom_line(colour = "#1380A1", linewidth = 1) +
  geom_hline(yintercept = 0,
             linewidth = 1,
             colour = "#333333") +
  scale_x_continuous(
    limits = c(1, 53),
    breaks = seq(0, 50, 5)
  ) +
  scale_y_continuous(
    limits = c(0, 1000),
    breaks = seq(0, 1000, 200),
  ) +
  facet_wrap(~ year, ncol = 1) +
  bbc_style()
```

